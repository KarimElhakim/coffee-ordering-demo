<!DOCTYPE html>
<html>
<head>
  <title>Cross-App Data Sync</title>
  <style>
    body {
      font-family: system-ui;
      padding: 40px;
      background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
      color: #fff;
      min-height: 100vh;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: #2a2a2a;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    }
    h1 { color: #4ade80; margin: 0 0 20px 0; }
    .status { margin: 20px 0; padding: 15px; background: #1a1a1a; border-radius: 8px; }
    .success { color: #4ade80; }
    .error { color: #f87171; }
    .warning { color: #fbbf24; }
    button {
      background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
      color: #000;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      margin: 5px;
      font-size: 14px;
      transition: transform 0.2s;
    }
    button:hover { transform: scale(1.05); }
    button:active { transform: scale(0.95); }
    .danger { background: linear-gradient(135deg, #f87171 0%, #ef4444 100%); }
    pre { background: #000; padding: 15px; border-radius: 8px; overflow-x: auto; font-size: 12px; }
    .section { margin: 30px 0; }
    .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0; }
    .card { background: #1a1a1a; padding: 20px; border-radius: 12px; text-align: center; }
    .card h3 { margin: 0 0 10px 0; font-size: 14px; color: #9ca3af; }
    .card .number { font-size: 36px; font-weight: bold; color: #4ade80; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîÑ Coffee Shop Data Sync</h1>
    <p style="color: #9ca3af; margin-bottom: 30px;">
      Since apps run on different ports, they have isolated localStorage.
      Use this page to sync data between them.
    </p>

    <div class="grid">
      <div class="card">
        <h3>üì¶ Orders</h3>
        <div class="number" id="orderCount">0</div>
      </div>
      <div class="card">
        <h3>üé´ Tickets</h3>
        <div class="number" id="ticketCount">0</div>
      </div>
      <div class="card">
        <h3>üçî Items</h3>
        <div class="number" id="itemCount">0</div>
      </div>
    </div>

    <div class="section">
      <button onclick="syncData()">üîÑ Sync All Data</button>
      <button onclick="checkData()">üìä Check Data</button>
      <button class="danger" onclick="clearAll()">üóëÔ∏è Clear Everything</button>
      <button onclick="createTestOrder()">‚ú® Create Test Order</button>
    </div>

    <div class="status" id="status">
      <p class="warning">‚è≥ Click "Check Data" to see current status</p>
    </div>

    <div class="section">
      <h3 style="color: #4ade80;">üìã Recent Orders</h3>
      <div id="orders"></div>
    </div>

    <div class="section">
      <h3 style="color: #4ade80;">üé´ KDS Tickets</h3>
      <div id="tickets"></div>
    </div>
  </div>

  <script>
    function checkData() {
      const orders = JSON.parse(localStorage.getItem('demo-orders') || '[]');
      const tickets = JSON.parse(localStorage.getItem('demo-kds-tickets') || '[]');
      const sharedOrders = JSON.parse(localStorage.getItem('demo-orders-shared') || '[]');
      const sharedTickets = JSON.parse(localStorage.getItem('demo-kds-tickets-shared') || '[]');
      
      let totalItems = 0;
      [...orders, ...sharedOrders].forEach(order => {
        const items = JSON.parse(localStorage.getItem(`demo-order-items-${order.id}`) || '[]');
        totalItems += items.length;
      });
      
      document.getElementById('orderCount').textContent = orders.length + sharedOrders.length;
      document.getElementById('ticketCount').textContent = tickets.length + sharedTickets.length;
      document.getElementById('itemCount').textContent = totalItems;
      
      let html = '<div>';
      html += `<p class="success">‚úì Local Orders: ${orders.length}</p>`;
      html += `<p class="success">‚úì Shared Orders: ${sharedOrders.length}</p>`;
      html += `<p class="success">‚úì Local Tickets: ${tickets.length}</p>`;
      html += `<p class="success">‚úì Shared Tickets: ${sharedTickets.length}</p>`;
      html += `<p class="success">‚úì Total Items: ${totalItems}</p>`;
      html += '</div>';
      document.getElementById('status').innerHTML = html;
      
      // Display orders
      const allOrders = [...orders, ...sharedOrders];
      if (allOrders.length > 0) {
        let ordersHtml = '<pre>';
        allOrders.forEach(o => {
          ordersHtml += `${o.order_number || o.id.slice(0,8)} - ${o.status} - ${o.customer_name || 'No name'} - ${o.customer_phone || 'No phone'}\n`;
        });
        ordersHtml += '</pre>';
        document.getElementById('orders').innerHTML = ordersHtml;
      } else {
        document.getElementById('orders').innerHTML = '<p class="error">No orders found</p>';
      }
      
      // Display tickets
      const allTickets = [...tickets, ...sharedTickets];
      if (allTickets.length > 0) {
        let ticketsHtml = '<pre>';
        allTickets.forEach(t => {
          ticketsHtml += `${t.id.slice(0,15)}... ‚Üí Order: ${t.order_id.slice(0,15)}... - Station: ${t.station_id} - ${t.status}\n`;
        });
        ticketsHtml += '</pre>';
        document.getElementById('tickets').innerHTML = ticketsHtml;
      } else {
        document.getElementById('tickets').innerHTML = '<p class="error">No tickets found</p>';
      }
    }
    
    function syncData() {
      // Merge local and shared
      const localOrders = JSON.parse(localStorage.getItem('demo-orders') || '[]');
      const sharedOrders = JSON.parse(localStorage.getItem('demo-orders-shared') || '[]');
      const allOrders = [...localOrders, ...sharedOrders];
      const uniqueOrders = allOrders.filter((order, index, self) =>
        index === self.findIndex((o) => o.id === order.id)
      );
      
      const localTickets = JSON.parse(localStorage.getItem('demo-kds-tickets') || '[]');
      const sharedTickets = JSON.parse(localStorage.getItem('demo-kds-tickets-shared') || '[]');
      const allTickets = [...localTickets, ...sharedTickets];
      const uniqueTickets = allTickets.filter((ticket, index, self) =>
        index === self.findIndex((t) => t.id === ticket.id)
      );
      
      // Write to both local and shared
      localStorage.setItem('demo-orders', JSON.stringify(uniqueOrders));
      localStorage.setItem('demo-orders-shared', JSON.stringify(uniqueOrders));
      localStorage.setItem('demo-kds-tickets', JSON.stringify(uniqueTickets));
      localStorage.setItem('demo-kds-tickets-shared', JSON.stringify(uniqueTickets));
      
      alert(`‚úÖ Synced!\n${uniqueOrders.length} orders\n${uniqueTickets.length} tickets`);
      checkData();
    }
    
    function clearAll() {
      if (confirm('‚ö†Ô∏è Clear ALL data? This will remove all orders and tickets.')) {
        localStorage.clear();
        alert('‚úÖ All data cleared!');
        checkData();
      }
    }
    
    function createTestOrder() {
      const timestamp = Date.now();
      const orderId = `order-test-${timestamp}`;
      const orderNumber = `ORD-TEST${String(timestamp).slice(-3)}`;
      
      const order = {
        id: orderId,
        order_number: orderNumber,
        store_id: '1',
        table_id: null,
        channel: 'cashier',
        status: 'new',
        total_amount: 75.00,
        customer_name: 'Test Customer',
        customer_phone: '01234567890',
        location: 'test',
        created_at: new Date().toISOString(),
      };
      
      const items = [{
        id: `item-${orderId}-0`,
        order_id: orderId,
        menu_item_id: 'item-cappuccino',
        qty: 2,
        price_each: 35,
        note: 'Test order - should appear in KDS',
        menu_item: { name: 'Cappuccino' },
        options: [
          { key: 'Size', value: 'Large', price_delta: 10 },
          { key: 'Milk', value: 'Oat Milk', price_delta: 3 }
        ]
      }];
      
      const ticket = {
        id: `ticket-test-${timestamp}`,
        order_id: orderId,
        station_id: 'station-bar',
        status: 'new',
        bumped_by: null,
        created_at: new Date().toISOString(),
      };
      
      // Save to BOTH local and shared
      const orders = JSON.parse(localStorage.getItem('demo-orders') || '[]');
      orders.push(order);
      localStorage.setItem('demo-orders', JSON.stringify(orders));
      localStorage.setItem('demo-orders-shared', JSON.stringify(orders));
      
      const tickets = JSON.parse(localStorage.getItem('demo-kds-tickets') || '[]');
      tickets.push(ticket);
      localStorage.setItem('demo-kds-tickets', JSON.stringify(tickets));
      localStorage.setItem('demo-kds-tickets-shared', JSON.stringify(tickets));
      
      localStorage.setItem(`demo-order-items-${orderId}`, JSON.stringify(items));
      
      alert(`‚úÖ Test Order Created!\n\n${orderNumber}\nID: ${orderId}\n\nNow open KDS and refresh to see it!`);
      checkData();
    }
    
    // Auto-check on load
    window.onload = checkData;
    
    // Auto-refresh every 5 seconds
    setInterval(checkData, 5000);
  </script>
</body>
</html>

